# 2025-12-10 Day 3 작업 로그

## 작업 내용

### DB 테이블 통합: profiles → users

#### 1. 문제 상황
- `profiles` 테이블과 `users` 테이블이 중복 존재
- `users` 테이블에 `streak_count`, `last_journal_date` 컬럼이 이미 있음
- 코드는 `profiles` 테이블만 사용 중이었음

#### 2. 해결: profiles → users 마이그레이션
- `+page.server.ts` - `profiles` → `users` 테이블 조회로 변경
- `settings/+page.server.ts` - `profiles` → `users` 테이블 조회로 변경
- `api/profile/+server.ts` 삭제 → `api/user/+server.ts` 신규 생성
- `onboarding/+page.svelte` - API 경로 `/api/profile` → `/api/user`로 변경

#### 3. 스트릭 캐싱 구현
- `api/journal/+server.ts`에 `updateStreakCache()` 함수 추가
- 일기 저장 시 `users.streak_count`, `users.last_journal_date` 자동 업데이트
- `+page.server.ts`에서 캐시된 스트릭 값 우선 사용 (오래된 경우만 재계산)

#### 4. TECH_SPEC.md 업데이트
- `profiles` 테이블 스키마 → `users` 테이블 스키마로 변경
- `streak_count`, `last_journal_date` 컬럼 문서화

---

### 플로우 변경: 자동저장 → 사용자 선택

#### 1. 변경 사항
- **이전**: 이미지 생성 후 자동 저장 → "새 일기 쓰기" 버튼만 존재
- **이후**: 이미지 생성 후 미리보기 → "일기 저장해요!" / "일기 다시쓸래요~" 선택

#### 2. 구현
- `journalCreation.svelte.ts`에 `preview` 상태 추가
- `+page.svelte`에 미리보기 UI 추가 (두 개 버튼)
- 저장 시에만 DB에 기록

---

### 한도 관리 버그 수정 (2차 개선)

#### 1. 1차 문제
- 일기 삭제 시 한도가 복구되는 버그 (악용 가능)
- 기존: `journals` 테이블 카운트로 한도 체크

#### 2. 1차 해결
- `users` 테이블에 `daily_usage_count`, `daily_usage_date` 컬럼 추가
- 일기 저장 시 카운트 증가 (삭제해도 유지)
- 날짜가 바뀌면 자동 리셋

#### 3. 2차 문제 (추가 발견)
- "다시쓸래요" 무한 악용 가능
- 저장 시점에 카운트 → API 비용은 이미 발생했는데 저장 안 하면 카운트 안 됨

#### 4. 2차 해결: API 호출 시점에 카운트
- `api/transcribe/+server.ts`에서 STT API 호출 **전에** 카운트 증가
- `api/journal/+server.ts`에서 카운트 로직 제거
- 비용 발생 시점 = 카운트 시점으로 일치

#### 5. 수정된 파일
- `api/transcribe/+server.ts` - 인증 + 사용량 체크 + 카운트 증가 추가
- `api/journal/+server.ts` - 사용량 카운트 로직 제거
- `api/usage/+server.ts` - `daily_usage_count`로 한도 체크
- `+page.server.ts` - `daily_usage_count`로 한도 체크
- `+page.svelte` - `handleDiscardJournal`에 `loadUsage()` 추가

---

### UX 개선: 탭 네비게이션

#### 문제
- 일기 저장 완료 후 "기록" 탭 클릭해도 완료 화면 유지
- 사용자가 새 녹음을 시작하려면 "새 일기 쓰기" 버튼을 눌러야 함

#### 해결
- `BottomNav.svelte`에서 "기록" 탭 클릭 시 `journalCreationStore.reset()` 호출
- 어디서든 "기록" 탭 클릭하면 녹음 대기 화면으로 이동

---

## 변경된 파일

### 신규 생성
- `src/routes/api/user/+server.ts` - 유저 정보 조회/저장 API
- `docs/work-logs/2025-12-10.day3.md` - 이 파일

### 수정
- `src/routes/+page.svelte` - 플로우 변경 (미리보기 + 버튼 2개) + loadUsage 추가
- `src/routes/+page.server.ts` - daily_usage_count 사용
- `src/routes/settings/+page.server.ts` - users 테이블 사용
- `src/routes/onboarding/+page.svelte` - API 경로 변경
- `src/routes/api/transcribe/+server.ts` - 인증 + 사용량 체크/카운트 추가
- `src/routes/api/journal/+server.ts` - 스트릭 캐시만 유지 (사용량 카운트 제거)
- `src/routes/api/usage/+server.ts` - daily_usage_count로 한도 체크
- `src/lib/stores/journalCreation.svelte.ts` - preview 상태 추가
- `src/lib/components/BottomNav.svelte` - 기록 탭 클릭 시 스토어 리셋
- `docs/TECH_SPEC.md` - DB 스키마 업데이트

### 삭제
- `src/routes/api/profile/+server.ts` - api/user로 대체

---

## 현재 상태

**Day 3 완료 - 모든 버그 수정 및 UX 개선 완료**

### 최종 플로우
1. 녹음 완료 → STT (사용량 카운트 여기서!) → AI 분석 → 이미지 생성
2. **미리보기 화면** (저장 전)
   - "일기 저장해요!" → DB 저장 + 완료 화면
   - "일기 다시쓸래요~" → 초기화 + 녹음 화면 (카운트는 이미 차감됨)
3. 완료 화면
   - "캘린더 보기" → 캘린더 페이지
   - "새 일기 쓰기" → 초기화 + 녹음 화면
4. 탭 네비게이션
   - "기록" 탭 클릭 → 항상 녹음 대기 화면으로 리셋

### 한도 관리 로직 (최종)
- 카운트 시점: **STT API 호출 직전** (비용 발생 시점)
- `users.daily_usage_count` - 오늘 API 사용 횟수
- `users.daily_usage_date` - 사용량 카운트 날짜
- 날짜가 바뀌면 자동 리셋 (카운트 0, 날짜 갱신)
- 삭제/다시쓰기해도 카운트 유지 (악용 방지)

### DB 구조 (최종)
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  nickname VARCHAR(50),
  notification_time TIME,
  streak_count INTEGER DEFAULT 0,
  last_journal_date DATE,
  daily_usage_count INTEGER DEFAULT 0,  -- 오늘 API 사용 횟수
  daily_usage_date DATE,                -- 사용량 카운트 날짜
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 테스트 완료

- [x] 녹음 → STT → 분석 → 이미지 생성 → 미리보기
- [x] "일기 저장해요!" → 저장 + 완료 화면
- [x] "일기 다시쓸래요~" → 녹음 화면 + 사용량 정확히 표시
- [x] "기록" 탭 클릭 → 녹음 화면으로 리셋
- [x] 일기 삭제해도 사용량 유지
- [x] 다시쓰기 반복해도 사용량 정확히 차감

---

## 참고

- 빌드 성공 (`npm run check` - 에러 0, 경고 6개는 Svelte 5 패턴)
- 타입 에러 없음
- Supabase 컬럼 추가 완료 (`daily_usage_count`, `daily_usage_date`)
