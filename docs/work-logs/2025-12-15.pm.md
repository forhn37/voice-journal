# 2025-12-15 PM 작업 로그

## 작업 시간
- 약 1.5시간

## 주요 작업

### Phase 2 기능 구현 - 일기 작성 리마인더 ✅

**목표**: 사용자가 매일 설정한 시간에 일기 작성 알림을 받을 수 있는 리마인더 기능 구현

**구현 내용**:

#### 1. 리마인더 유틸리티 (`src/lib/utils/reminder.ts`)

**핵심 기능**:
- 알림 권한 확인: `checkNotificationPermission()`
- 알림 권한 요청: `requestNotificationPermission()`
- 알림 스케줄링: `scheduleNotification(time)`
- 알림 취소: `cancelNotification()`
- 알림 표시: `showNotification()`
- 초기화: `initializeReminder()`

**알림 스케줄링 로직**:
```typescript
const [hour, minute] = time.split(':').map(Number);
const now = new Date();
const scheduledTime = new Date();
scheduledTime.setHours(hour, minute, 0, 0);

// 이미 지난 시간이면 내일로 설정
if (scheduledTime <= now) {
  scheduledTime.setDate(scheduledTime.getDate() + 1);
}

const delay = scheduledTime.getTime() - now.getTime();

const timerId = setTimeout(() => {
  showNotification();
  scheduleNotification(time); // 다음날 알림 재스케줄링
}, delay);

localStorage.setItem('notification_timer_id', String(timerId));
localStorage.setItem('notification_time', time);
```

**브라우저 알림**:
```typescript
new Notification('오늘 하루 어땠어?', {
  body: '일기를 작성하고 감정을 기록해보세요',
  icon: '/icon-192.png',
  badge: '/icon-192.png',
  tag: 'daily-reminder',
  requireInteraction: false
});
```

---

#### 2. 설정 페이지 UI (`src/routes/settings/+page.svelte`)

**리마인더 섹션 추가**:
- 알림 켜기/끄기 토글 스위치
- 알림 시간 선택 (HTML5 time input)
- 알림 권한 상태에 따른 안내 메시지
  - `default`: "알림 권한이 필요해요"
  - `granted`: "매일 설정한 시간에 알림을 받아요"
  - `denied`: "알림이 차단되어 있어요. 브라우저 설정에서 허용해주세요."

**토글 스위치 UI**:
```svelte
<label class="relative inline-flex items-center cursor-pointer">
  <input
    type="checkbox"
    bind:checked={notificationEnabled}
    onchange={toggleReminder}
    disabled={notificationPermission === 'denied'}
    class="sr-only peer"
  />
  <div class="w-11 h-6 bg-gray-200 peer-checked:bg-(--color-primary) ...">
  </div>
</label>
```

**시간 선택 UI** (알림 켜져 있을 때만 표시):
```svelte
{#if notificationEnabled}
  <input
    type="time"
    bind:value={notificationTime}
    onchange={changeNotificationTime}
  />
{/if}
```

**함수**:
- `toggleReminder()`: 알림 켜기/끄기, 권한 요청, DB 저장
- `changeNotificationTime()`: 알림 시간 변경, DB 저장, 재스케줄링

---

#### 3. 프로필 API (`src/routes/api/profile/+server.ts`)

**POST /api/profile**

**기능**:
- 닉네임 업데이트
- 알림 시간 업데이트 (notification_time)

**요청 바디**:
```typescript
{
  nickname?: string;
  notification_time?: string | null; // HH:MM 또는 null
}
```

**응답**:
```typescript
{
  success: true,
  message: '프로필이 업데이트되었어요'
}
```

**DB 업데이트**:
```typescript
const updates: Record<string, string | null> = {};

if ('nickname' in body) {
  updates.nickname = body.nickname;
}

if ('notification_time' in body) {
  updates.notification_time = body.notification_time;
}

await supabaseAdmin
  .from('users')
  .update(updates)
  .eq('id', userId);
```

---

#### 4. 메인 페이지 통합 (`src/routes/+page.svelte`)

**초기화 로직 추가**:
```typescript
import { initializeReminder } from '$lib/utils/reminder';

onMount(() => {
  loadTimeCapsule();
  initializeReminder(); // 저장된 알림 시간이 있으면 자동 스케줄링
});
```

---

#### 5. E2E 테스트 (`tests/reminder.spec.ts`)

**총 8개 테스트 케이스**:

1. **설정 페이지에 리마인더 섹션이 있어야 함**
   - "리마인더", "일기 알림" 텍스트 확인

2. **알림 토글 스위치가 표시되어야 함**
   - `input[type="checkbox"]` 존재 확인

3. **알림 켤 때 시간 선택 UI가 표시되어야 함**
   - `context.grantPermissions(['notifications'])`로 권한 부여
   - 토글 체크 후 `input[type="time"]` 표시 확인

4. **알림 시간을 변경할 수 있어야 함**
   - time input에 "09:00" 입력
   - 값 변경 확인

5. **알림을 끄면 시간 선택 UI가 사라져야 함**
   - 토글 언체크 후 `input[type="time"]` 비표시 확인

6. **프로필 API가 notification_time을 저장할 수 있어야 함**
   - POST /api/profile 호출
   - `{ notification_time: '21:00' }` 저장 확인

7. **프로필 API가 notification_time을 null로 설정할 수 있어야 함**
   - POST /api/profile 호출
   - `{ notification_time: null }` 저장 확인 (알림 끄기)

8. **알림 권한 상태에 따라 안내 메시지가 달라야 함**
   - 권한 부여 후 페이지 새로고침
   - 안내 메시지 텍스트 확인

---

## 기술적 구현

### 1. 브라우저 Notification API

**권한 체크**:
```typescript
if ('Notification' in window) {
  return Notification.permission; // 'default' | 'granted' | 'denied'
}
```

**권한 요청**:
```typescript
const permission = await Notification.requestPermission();
```

### 2. setTimeout 기반 스케줄링

**장점**:
- 간단한 구현
- 서버 없이 클라이언트에서 완결
- localStorage로 재시작 시 복원 가능

**단점**:
- 브라우저 종료 시 타이머 소실 (재접속 시 재스케줄링 필요)
- 정확도 낮음 (브라우저 백그라운드에서 제한됨)

**대안** (향후 개선 가능):
- Service Worker + Push API (웹 푸시 알림)
- 서버 크론잡 + 이메일/웹훅

### 3. localStorage 활용

**저장 데이터**:
```
notification_time: "21:00"
notification_timer_id: "12345"
```

**복원 로직** (`initializeReminder`):
```typescript
const savedTime = localStorage.getItem('notification_time');
if (savedTime && checkNotificationPermission() === 'granted') {
  scheduleNotification(savedTime);
}
```

---

## 커밋 내역

```
feat: 일기 작성 리마인더 기능 구현 (Phase 2)
- 설정 페이지에 리마인더 UI 추가
- 프로필 API 엔드포인트 생성 (/api/profile)
- 리마인더 유틸리티 함수 (reminder.ts)
- 메인 페이지에서 알림 초기화
- E2E 테스트 8개 작성
```

---

## 테스트 결과

- **타입 체크**: ✅ 0 errors, 8 warnings (기존 경고)
- **E2E 테스트**: 8개 테스트 작성 (reminder.spec.ts)

---

## 푸시 알림 (웹 푸시) 가능 여부

### ✅ 모바일 배포 없이 가능!

**현재 구현**: Notification API (브라우저 알림)
- 브라우저가 열려있을 때만 작동
- 간단하고 빠른 구현

**향후 개선 가능**: Service Worker + Push API
- 브라우저가 닫혀있어도 알림 가능
- HTTPS 필수 (Vercel ✅)
- 브라우저 지원:
  - Android Chrome: 완벽 지원 ✅
  - iOS Safari 16.4+: 홈 화면 추가 필요 ⚠️
  - Desktop: 완벽 지원 ✅

**구현 난이도**:
- Notification API (현재): 🟢 쉬움 (완료)
- Web Push API: 🟡 중간 (Service Worker + VAPID 키)

---

## 다음 작업 예정

### 남은 Phase 2 기능
- ~~푸시 알림 / 리마인더~~ ✅ 완료
  - ~~일기 작성 리마인더~~ ✅
  - 웹 푸시 알림 (선택사항 - Service Worker)

### 테스트 품질 향상
- 공유 기능 E2E 테스트 실행 (일기 데이터 필요)
- Mobile Safari 탭 전환 테스트 수정 (7개 실패)
- 테스트 커버리지 100% 달성

---

## 배운 점

1. **Notification API**: 브라우저 알림 권한 관리 및 표시
2. **setTimeout 재귀**: 매일 반복되는 알림 스케줄링
3. **localStorage 타이머 ID 저장**: 브라우저 재시작 대비
4. **Playwright 권한 테스트**: `context.grantPermissions(['notifications'])`
5. **토글 스위치 UI**: Tailwind peer 클래스 활용

---

## 참고 자료

- Notification API: https://developer.mozilla.org/en-US/docs/Web/API/Notifications_API
- Push API: https://developer.mozilla.org/en-US/docs/Web/API/Push_API
- Service Workers: https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API
