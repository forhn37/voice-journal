# 2025-12-10 Day 2 작업 로그

## 작업 내용

### Supabase Auth 연동 (Day 8)

#### 1. Auth 인프라 설정
- `$lib/supabase.ts` 생성 - 브라우저/서버용 Supabase 클라이언트
- `hooks.server.ts` 수정 - Auth 세션 핸들러 추가 (sequence로 Sentry와 결합)
- `app.d.ts` 수정 - Locals, PageData 타입 정의
- `+layout.server.ts` 생성 - 서버사이드 세션 로드
- `+layout.ts` 생성 - 클라이언트 세션 관리
- `+layout.svelte` 수정 - Auth 상태 변화 감지

#### 2. 로그인/회원가입 페이지
- `login/+page.svelte` 생성
  - 이메일/비밀번호 로그인
  - 회원가입 모드 전환
  - Google OAuth 로그인 버튼
  - 에러 메시지 표시

#### 3. Auth 콜백 라우트
- `auth/callback/+server.ts` - OAuth 콜백 처리
- `auth/logout/+server.ts` - 로그아웃 API

#### 4. API에 user_id 적용
- `api/journal/+server.ts` 수정
  - POST: 세션에서 user_id 가져와서 저장
  - GET: 본인 일기만 조회하도록 수정
  - 사용량 체크도 유저별로 변경
- `api/usage/+server.ts` 수정
  - 세션에서 user_id 가져와서 해당 유저의 사용량만 조회

#### 5. 프로필 API
- `api/profile/+server.ts` 생성
  - GET: 프로필 조회
  - POST: 프로필 생성/업데이트 (upsert)

#### 6. 페이지 Auth 연동
- `+page.svelte` (메인) - 로그인 체크 추가
- `onboarding/+page.svelte` - 로그인 체크 + 프로필 저장
- `calendar/+page.svelte` - 로그인 체크 추가
- `journal/[id]/+page.svelte` - 로그인 체크 추가

## 변경된 파일

### 신규 생성
- `src/lib/supabase.ts`
- `src/routes/+layout.server.ts`
- `src/routes/+layout.ts`
- `src/routes/login/+page.svelte`
- `src/routes/auth/callback/+server.ts`
- `src/routes/auth/logout/+server.ts`
- `src/routes/api/profile/+server.ts`
- `docs/work-logs/2025-12-10.day2.md`

### 수정
- `src/hooks.server.ts` - Supabase Auth 핸들 추가
- `src/app.d.ts` - Locals, PageData 타입 정의
- `src/routes/+layout.svelte` - Auth 상태 변화 감지
- `src/routes/+page.svelte` - 로그인 체크
- `src/routes/onboarding/+page.svelte` - 로그인 체크 + 프로필 저장
- `src/routes/calendar/+page.svelte` - 로그인 체크
- `src/routes/journal/[id]/+page.svelte` - 로그인 체크
- `src/routes/api/journal/+server.ts` - user_id 적용
- `src/routes/api/usage/+server.ts` - user_id 적용
- `docs/STATUS.md` - 진행 상황 업데이트

## 현재 상태

**Supabase Auth 연동 완료** (Day 8 수준)

### Auth 플로우
1. 비로그인 유저 → 메인/캘린더/상세 → 로그인 페이지로 리다이렉트
2. 로그인 페이지 → 이메일 또는 Google 로그인
3. 로그인 성공 → 온보딩 페이지 (프로필 없으면)
4. 온보딩 완료 → 메인 페이지

### 보안
- 서버사이드에서 세션 검증 (getUser)
- API에서 본인 데이터만 접근 가능
- user_id를 세션에서 가져와서 사용 (클라이언트 전달 X)

## 다음 작업 (우선순위)

1. 에러 처리 강화 (재시도 버튼, 에러 UI)
2. UI/UX 다듬기 (빈 상태 UI, 로딩 스켈레톤)
3. 스트릭 시스템
4. Vercel 배포

## 참고

- Supabase 대시보드에서 Google OAuth 활성화 필요
- RLS 정책은 이미 TECH_SPEC.md에 정의되어 있음 (DB에 적용 필요)
